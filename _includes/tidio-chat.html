<!-- Tidio Chat Integration with Context-Aware Greetings and Fallback -->
<div class="chat-integration" id="chat-integration">
    <!-- Tidio Chat Widget -->
    {% if site.tidio_key and site.tidio_key != "" %}
    <div class="tidio-chat" id="tidio-chat">
        <script>
            // Tidio configuration with context awareness
            document.tidioChatApi = {
                on: {
                    ready: function() {
                        window.chatIntegration?.onTidioReady();
                    },
                    close: function() {
                        window.chatIntegration?.onTidioClose();
                    },
                    open: function() {
                        window.chatIntegration?.onTidioOpen();
                    }
                }
            };
        </script>
        <script src="//code.tidio.co/{{ site.tidio_key }}.js" async></script>
    </div>
    {% endif %}
    
    <!-- Fallback Chat Widget -->
    <div class="chat-fallback" id="chat-fallback" style="{{ site.tidio_key | if: 'display: none;', 'display: block;' }}">
        <div class="chat-widget">
            <div class="chat-toggle" id="chat-toggle">
                <div class="chat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
                    </svg>
                </div>
                <div class="chat-notification" id="chat-notification" style="display: none;">
                    <span class="notification-count">1</span>
                </div>
                <div class="chat-status-indicator" id="chat-status"></div>
            </div>
            
            <div class="chat-window" id="chat-window" style="display: none;">
                <div class="chat-header">
                    <div class="chat-agent-info">
                        <div class="agent-avatar">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM0Qzc3MzkiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Im0zIDIxIDEuOS01LjdhOC41IDguNSAwIDEgMSAzLjggMy44eiIvPgo8L3N2Zz4KPC9zdmc+" alt="Assistente Bioarchitettura">
                        </div>
                        <div class="agent-details">
                            <h4 data-translate="chat.agent_name">Assistente Bioarchitettura</h4>
                            <span class="agent-status online" data-translate="chat.agent_status">Online</span>
                        </div>
                    </div>
                    <div class="chat-controls">
                        <button class="minimize-btn" id="minimize-chat" title="Minimizza">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <button class="close-btn" id="close-chat" title="Chiudi">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <!-- Initial greeting will be inserted here -->
                </div>
                
                <div class="chat-input-container">
                    <div class="quick-actions" id="quick-actions">
                        <button class="quick-action" data-message="Vorrei informazioni sui vostri corsi di bioarchitettura">
                            üìö Corsi
                        </button>
                        <button class="quick-action" data-message="Che cos'√® la bioarchitettura?">
                            üè° Info Bioarchitettura
                        </button>
                        <button class="quick-action" data-message="Come posso richiedere una consulenza?">
                            üíº Consulenza
                        </button>
                    </div>
                    
                    <div class="chat-input-area">
                        <textarea 
                            id="chat-input" 
                            placeholder="Scrivi il tuo messaggio..." 
                            data-translate-placeholder="chat.input_placeholder"
                            rows="1"></textarea>
                        <button class="send-btn" id="send-message" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="chat-typing-indicator" id="typing-indicator" style="display: none;">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span data-translate="chat.typing">L'assistente sta scrivendo...</span>
                    </div>
                </div>
                
                <div class="chat-footer">
                    <p class="chat-disclaimer" data-translate="chat.disclaimer">
                        ü§ñ Assistente AI - Le risposte sono generate automaticamente
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat Welcome Modal -->
    <div class="chat-welcome-modal" id="chat-welcome-modal" style="display: none;">
        <div class="welcome-content">
            <div class="welcome-header">
                <h3 data-translate="chat.welcome_title">Benvenuto!</h3>
                <button class="close-welcome" id="close-welcome">√ó</button>
            </div>
            <div class="welcome-body">
                <p data-translate="chat.welcome_message">
                    Hai bisogno di aiuto con la bioarchitettura? Il nostro assistente AI √® qui per rispondere alle tue domande su costruzione sostenibile, materiali ecologici e molto altro.
                </p>
                <div class="welcome-topics">
                    <h4 data-translate="chat.welcome_topics_title">Posso aiutarti con:</h4>
                    <ul>
                        <li data-translate="chat.topic_1">Informazioni sui corsi e certificazioni</li>
                        <li data-translate="chat.topic_2">Consigli su materiali naturali</li>
                        <li data-translate="chat.topic_3">Efficienza energetica degli edifici</li>
                        <li data-translate="chat.topic_4">Normative e certificazioni green</li>
                    </ul>
                </div>
            </div>
            <div class="welcome-actions">
                <button class="start-chat-btn" id="start-chat" data-translate="chat.start_chat">
                    Inizia la conversazione
                </button>
                <button class="maybe-later-btn" id="maybe-later" data-translate="chat.maybe_later">
                    Forse pi√π tardi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Advanced Chat Integration System
 * Supports Tidio with fallback to custom AI-powered chat
 */
class ChatIntegration {
    constructor() {
        this.config = {
            tidioKey: '{{ site.tidio_key }}',
            fallbackEnabled: true,
            contextAware: true,
            welcomeDelay: {{ site.chat_welcome_delay | default: 15000 }}, // 15 seconds
            autoGreeting: true,
            maxRetries: 3,
            retryDelay: 2000
        };
        
        this.state = {
            isOpen: false,
            isMinimized: false,
            hasShownWelcome: localStorage.getItem('chat_welcome_shown') === 'true',
            currentContext: null,
            messageHistory: [],
            userPreferences: this.loadUserPreferences()
        };
        
        this.tidioAvailable = false;
        this.fallbackActive = false;
        this.welcomeTimer = null;
        
        this.init();
    }
    
    init() {
        this.detectPageContext();
        this.setupEventListeners();
        this.initializeChatSystem();
        this.scheduleWelcomeMessage();
    }
    
    detectPageContext() {
        // Analyze current page to provide context-aware assistance
        const path = window.location.pathname;
        const title = document.title;
        const category = document.querySelector('meta[name="category"]')?.content;
        const tags = document.querySelector('meta[name="keywords"]')?.content?.split(',');
        
        this.state.currentContext = {
            path,
            title,
            category,
            tags: tags || [],
            pageType: this.determinePageType(path),
            timestamp: Date.now()
        };
    }
    
    determinePageType(path) {
        if (path === '/' || path === '/index.html') return 'home';
        if (path.includes('/shop/')) return 'shop';
        if (path.includes('/posts/') || path.includes('/2024/')) return 'article';
        if (path.includes('/chi-siamo/')) return 'about';
        if (path.includes('/contatti/')) return 'contact';
        if (path.includes('/corsi/')) return 'courses';
        return 'other';
    }
    
    setupEventListeners() {
        // Chat toggle
        const chatToggle = document.getElementById('chat-toggle');
        if (chatToggle) {
            chatToggle.addEventListener('click', () => this.toggleChat());
        }
        
        // Chat controls
        const minimizeBtn = document.getElementById('minimize-chat');
        const closeBtn = document.getElementById('close-chat');
        
        if (minimizeBtn) {
            minimizeBtn.addEventListener('click', () => this.minimizeChat());
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closeChat());
        }
        
        // Welcome modal
        this.setupWelcomeModal();
        
        // Message input
        this.setupMessageInput();
        
        // Quick actions
        this.setupQuickActions();
        
        // Page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && this.shouldShowProactiveMessage()) {
                this.showProactiveMessage();
            }
        });
        
        // Scroll behavior for proactive messages
        this.setupScrollTriggers();
    }
    
    setupWelcomeModal() {
        const startChatBtn = document.getElementById('start-chat');
        const maybeLaterBtn = document.getElementById('maybe-later');
        const closeWelcomeBtn = document.getElementById('close-welcome');
        
        if (startChatBtn) {
            startChatBtn.addEventListener('click', () => {
                this.hideWelcomeModal();
                this.openChat();
                this.state.hasShownWelcome = true;
                localStorage.setItem('chat_welcome_shown', 'true');
            });
        }
        
        if (maybeLaterBtn || closeWelcomeBtn) {
            [maybeLaterBtn, closeWelcomeBtn].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        this.hideWelcomeModal();
                        this.state.hasShownWelcome = true;
                        localStorage.setItem('chat_welcome_shown', 'true');
                    });
                }
            });
        }
    }
    
    setupMessageInput() {
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-message');
        
        if (chatInput && sendBtn) {
            chatInput.addEventListener('input', (e) => {
                sendBtn.disabled = e.target.value.trim().length === 0;
                this.autoResizeTextarea(e.target);
            });
            
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', () => this.sendMessage());
        }
    }
    
    setupQuickActions() {
        const quickActions = document.querySelectorAll('.quick-action');
        quickActions.forEach(action => {
            action.addEventListener('click', (e) => {
                const message = e.target.dataset.message;
                if (message) {
                    this.sendQuickMessage(message);
                }
            });
        });
    }
    
    setupScrollTriggers() {
        let scrollTimeout;
        let scrollDistance = 0;
        
        window.addEventListener('scroll', () => {
            scrollDistance = window.pageYOffset;
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                if (scrollDistance > 1000 && !this.state.isOpen && 
                    this.shouldShowScrollTrigger()) {
                    this.showScrollTriggerMessage();
                }
            }, 2000);
        });
    }
    
    async initializeChatSystem() {
        // Check if Tidio is available
        if (this.config.tidioKey) {
            try {
                await this.waitForTidio();
                this.tidioAvailable = true;
                console.log('Tidio chat initialized');
                this.setupTidioIntegration();
            } catch (error) {
                console.warn('Tidio not available, using fallback:', error);
                this.initializeFallbackChat();
            }
        } else {
            this.initializeFallbackChat();
        }
    }
    
    waitForTidio(timeout = 10000) {
        return new Promise((resolve, reject) => {
            const checkTidio = () => {
                if (window.tidioChatApi) {
                    resolve();
                } else {
                    setTimeout(checkTidio, 500);
                }
            };
            
            setTimeout(() => reject(new Error('Tidio timeout')), timeout);
            checkTidio();
        });
    }
    
    setupTidioIntegration() {
        // Customize Tidio with context-aware messages
        if (window.tidioChatApi) {
            this.sendContextToTidio();
        }
    }
    
    sendContextToTidio() {
        const context = this.state.currentContext;
        const greeting = this.generateContextualGreeting(context);
        
        // Send context information to Tidio
        if (window.tidioChatApi?.trigger) {
            window.tidioChatApi.trigger('sendMessage', {
                text: greeting,
                sender: 'visitor'
            });
        }
    }
    
    initializeFallbackChat() {
        this.fallbackActive = true;
        const fallbackEl = document.getElementById('chat-fallback');
        if (fallbackEl) {
            fallbackEl.style.display = 'block';
        }
        
        // Hide Tidio if present
        const tidioEl = document.getElementById('tidio-chat');
        if (tidioEl) {
            tidioEl.style.display = 'none';
        }
        
        // Send initial greeting
        setTimeout(() => {
            this.sendInitialGreeting();
        }, 1000);
    }
    
    scheduleWelcomeMessage() {
        if (this.state.hasShownWelcome) return;
        
        this.welcomeTimer = setTimeout(() => {
            this.showWelcomeModal();
        }, this.config.welcomeDelay);
    }
    
    showWelcomeModal() {
        const modal = document.getElementById('chat-welcome-modal');
        if (modal && !this.state.hasShownWelcome) {
            modal.style.display = 'flex';
            
            // Animate in
            setTimeout(() => {
                modal.classList.add('show');
            }, 50);
        }
    }
    
    hideWelcomeModal() {
        const modal = document.getElementById('chat-welcome-modal');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    }
    
    toggleChat() {
        if (this.state.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }
    
    openChat() {
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow) {
            chatWindow.style.display = 'block';
            this.state.isOpen = true;
            this.state.isMinimized = false;
            
            // Update toggle icon
            this.updateChatToggleIcon('close');
            
            // Focus input
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                setTimeout(() => chatInput.focus(), 100);
            }
            
            // Mark notification as read
            this.clearNotification();
            
            // Track event
            this.trackChatEvent('opened');
        }
    }
    
    closeChat() {
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow) {
            chatWindow.style.display = 'none';
            this.state.isOpen = false;
            this.state.isMinimized = false;
            
            // Update toggle icon
            this.updateChatToggleIcon('open');
            
            // Track event
            this.trackChatEvent('closed');
        }
    }
    
    minimizeChat() {
        this.closeChat();
        this.state.isMinimized = true;
        
        // Show notification if there are unread messages
        this.showNotification();
    }
    
    updateChatToggleIcon(state) {
        const chatToggle = document.getElementById('chat-toggle');
        if (chatToggle) {
            const icon = chatToggle.querySelector('.chat-icon svg');
            if (icon && state === 'close') {
                icon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>';
            } else if (icon) {
                icon.innerHTML = '<path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>';
            }
        }
    }
    
    showNotification() {
        const notification = document.getElementById('chat-notification');
        if (notification) {
            notification.style.display = 'block';
        }
    }
    
    clearNotification() {
        const notification = document.getElementById('chat-notification');
        if (notification) {
            notification.style.display = 'none';
        }
    }
    
    sendInitialGreeting() {
        const greeting = this.generateContextualGreeting(this.state.currentContext);
        this.addMessage('assistant', greeting, true);
        
        // Show follow-up suggestions based on context
        setTimeout(() => {
            const suggestions = this.generateContextualSuggestions();
            if (suggestions.length > 0) {
                this.addSuggestions(suggestions);
            }
        }, 2000);
    }
    
    generateContextualGreeting(context) {
        const greetings = {
            home: "üëã Benvenuto! Sono l'assistente AI di Bioarchitettura. Come posso aiutarti nel tuo percorso verso la costruzione sostenibile?",
            article: `üìñ Ciao! Vedo che stai leggendo "${context.title}". Hai domande specifiche sull'argomento o vuoi approfondire qualche aspetto?`,
            shop: "üõí Ciao! Stai esplorando il nostro shop. Posso aiutarti a trovare il corso o la risorsa pi√π adatta alle tue esigenze!",
            about: "üè¢ Ciao! Vuoi saperne di pi√π sulla Fondazione Bioarchitettura? Sono qui per rispondere alle tue domande sulla nostra missione e i nostri servizi.",
            contact: "üìû Ciao! Stai cercando informazioni di contatto? Posso aiutarti a orientarti verso il servizio pi√π adatto alle tue esigenze.",
            courses: "üéì Benvenuto nella sezione corsi! Posso aiutarti a scegliere il percorso formativo pi√π adatto al tuo livello e ai tuoi obiettivi.",
            other: "üëã Ciao! Sono l'assistente AI di Bioarchitettura. Come posso aiutarti oggi?"
        };
        
        return greetings[context.pageType] || greetings.other;
    }
    
    generateContextualSuggestions() {
        const context = this.state.currentContext;
        const suggestions = {
            home: [
                "Cos'√® la bioarchitettura?",
                "Quali corsi offrite?",
                "Come iniziare un progetto sostenibile?"
            ],
            article: [
                "Spiegami meglio questo concetto",
                "Hai altri articoli correlati?",
                "Come posso applicare queste informazioni?"
            ],
            shop: [
                "Quale corso √® adatto a un principiante?",
                "Offrite certificazioni riconosciute?",
                "Ci sono sconti per studenti?"
            ],
            courses: [
                "Qual √® la durata dei corsi?",
                "I corsi sono online o in presenza?",
                "Rilasciate attestati?"
            ]
        };
        
        return suggestions[context.pageType] || suggestions.home;
    }
    
    addMessage(sender, content, isInitial = false) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;
        
        const messageEl = document.createElement('div');
        messageEl.className = `chat-message ${sender}${isInitial ? ' initial' : ''}`;
        
        const timestamp = new Date().toLocaleTimeString('it-IT', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageEl.innerHTML = `
            <div class="message-content">
                <div class="message-text">${content}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageEl);
        this.scrollToBottom();
        
        // Store in history
        this.state.messageHistory.push({
            sender,
            content,
            timestamp: Date.now()
        });
    }
    
    addSuggestions(suggestions) {
        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) return;
        
        const suggestionsEl = document.createElement('div');
        suggestionsEl.className = 'chat-suggestions';
        
        const suggestionsHtml = suggestions.map(suggestion => 
            `<button class="suggestion-btn" data-suggestion="${suggestion}">${suggestion}</button>`
        ).join('');
        
        suggestionsEl.innerHTML = `
            <div class="suggestions-label">Suggerimenti:</div>
            <div class="suggestions-buttons">${suggestionsHtml}</div>
        `;
        
        // Add click handlers
        suggestionsEl.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.sendQuickMessage(e.target.dataset.suggestion);
                suggestionsEl.remove(); // Remove suggestions after use
            });
        });
        
        messagesContainer.appendChild(suggestionsEl);
        this.scrollToBottom();
    }
    
    sendMessage() {
        const chatInput = document.getElementById('chat-input');
        const message = chatInput?.value.trim();
        
        if (!message) return;
        
        // Add user message
        this.addMessage('user', message);
        
        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        document.getElementById('send-message').disabled = true;
        
        // Show typing indicator
        this.showTypingIndicator();
        
        // Simulate AI response
        setTimeout(() => {
            this.generateAIResponse(message);
        }, 1000 + Math.random() * 2000);
    }
    
    sendQuickMessage(message) {
        // Open chat if closed
        if (!this.state.isOpen) {
            this.openChat();
        }
        
        // Add user message
        this.addMessage('user', message);
        
        // Show typing indicator
        this.showTypingIndicator();
        
        // Generate response
        setTimeout(() => {
            this.generateAIResponse(message);
        }, 1000 + Math.random() * 1500);
    }
    
    showTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.style.display = 'flex';
            this.scrollToBottom();
        }
    }
    
    hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    generateAIResponse(userMessage) {
        this.hideTypingIndicator();
        
        // Simple rule-based responses for demo
        const responses = this.getContextualResponses(userMessage.toLowerCase());
        const response = responses[Math.floor(Math.random() * responses.length)];
        
        this.addMessage('assistant', response);
        
        // Track interaction
        this.trackChatEvent('message_sent', { userMessage, response });
    }
    
    getContextualResponses(message) {
        // Simple keyword-based responses
        if (message.includes('bioarchitettura') || message.includes('cosa')) {
            return [
                "La bioarchitettura √® l'approccio al costruire che rispetta l'ambiente e la salute umana. Si basa su principi di sostenibilit√†, uso di materiali naturali e efficienza energetica. üè°‚ôªÔ∏è",
                "La bioarchitettura integra tecniche costruttive tradizionali con innovazioni moderne per creare edifici salubri ed ecosostenibili. Vuoi saperne di pi√π su qualche aspetto specifico?"
            ];
        }
        
        if (message.includes('corso') || message.includes('formazione')) {
            return [
                "Offriamo diversi percorsi formativi: dal corso base di introduzione alla bioarchitettura, fino ai master specialistici. Tutti i nostri corsi rilasciano attestati riconosciuti. üìö‚ú®",
                "I nostri corsi sono sia online che in presenza, con docenti esperti del settore. Vuoi informazioni su un corso specifico?"
            ];
        }
        
        if (message.includes('materiali') || message.includes('naturali')) {
            return [
                "I materiali naturali come legno, paglia, terra cruda e canapa sono fondamentali in bioarchitettura. Offrono ottime prestazioni termiche e rispettano l'ambiente. üåøüèóÔ∏è",
                "Ogni materiale naturale ha caratteristiche specifiche. Ti interessa approfondire qualche materiale in particolare?"
            ];
        }
        
        if (message.includes('costo') || message.includes('prezzo')) {
            return [
                "I costi variano in base al tipo di corso e durata. Offriamo anche agevolazioni per studenti e professionisti. Contattaci per un preventivo personalizzato! üí∞üìû",
                "Investire nella formazione in bioarchitettura √® un investimento nel futuro. Ti mandiamo tutte le informazioni sui prezzi via email?"
            ];
        }
        
        if (message.includes('certificazione') || message.includes('attestato')) {
            return [
                "Tutti i nostri corsi rilasciano attestati riconosciuti a livello nazionale. Per i corsi avanzati rilasciamo anche certificazioni internazionali. üèÜüìú",
                "Le nostre certificazioni sono riconosciute dalle principali associazioni professionali del settore. Vuoi vedere i dettagli?"
            ];
        }
        
        // Default responses
        return [
            "Interessante domanda! Per fornirti la risposta pi√π accurata, ti consiglio di contattare direttamente i nostri esperti. Nel frattempo, posso aiutarti con altre informazioni? ü§îüí°",
            "Grazie per la tua domanda. Per approfondimenti specifici, ti suggerisco di esplorare i nostri articoli o di contattare il nostro team di esperti. C'√® altro su cui posso aiutarti? üìñüë•",
            "Ottima domanda! Potresti trovare informazioni dettagliate nella nostra sezione risorse. Vuoi che ti aiuti a navigare verso una sezione specifica del sito? üîçüóÇÔ∏è"
        ];
    }
    
    scrollToBottom() {
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    
    autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    shouldShowProactiveMessage() {
        const now = Date.now();
        const lastProactive = localStorage.getItem('last_proactive_message');
        const timeSinceLastProactive = now - (lastProactive ? parseInt(lastProactive) : 0);
        
        return timeSinceLastProactive > 300000; // 5 minutes
    }
    
    shouldShowScrollTrigger() {
        const scrollTriggerShown = localStorage.getItem('scroll_trigger_shown');
        return !scrollTriggerShown || Date.now() - parseInt(scrollTriggerShown) > 86400000; // 24 hours
    }
    
    showProactiveMessage() {
        if (!this.state.isOpen) {
            this.showNotification();
            localStorage.setItem('last_proactive_message', Date.now().toString());
        }
    }
    
    showScrollTriggerMessage() {
        this.showNotification();
        localStorage.setItem('scroll_trigger_shown', Date.now().toString());
    }
    
    // Tidio event handlers
    onTidioReady() {
        console.log('Tidio is ready');
        this.sendContextToTidio();
    }
    
    onTidioOpen() {
        this.state.isOpen = true;
        this.trackChatEvent('tidio_opened');
    }
    
    onTidioClose() {
        this.state.isOpen = false;
        this.trackChatEvent('tidio_closed');
    }
    
    loadUserPreferences() {
        const stored = localStorage.getItem('chat_preferences');
        return stored ? JSON.parse(stored) : {
            language: 'it',
            notifications: true,
            lastInteraction: null
        };
    }
    
    saveUserPreferences() {
        localStorage.setItem('chat_preferences', JSON.stringify(this.state.userPreferences));
    }
    
    trackChatEvent(event, data = {}) {
        const eventData = {
            event,
            timestamp: Date.now(),
            context: this.state.currentContext,
            chatType: this.tidioAvailable ? 'tidio' : 'fallback',
            ...data
        };
        
        // Send to analytics if available
        if (window.gtag) {
            window.gtag('event', 'chat_interaction', {
                event_category: 'Chat',
                event_label: event,
                value: 1
            });
        }
        
        // Store locally for analysis
        const events = JSON.parse(localStorage.getItem('chat_events') || '[]');
        events.unshift(eventData);
        localStorage.setItem('chat_events', JSON.stringify(events.slice(0, 100)));
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.chatIntegration = new ChatIntegration();
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (window.chatIntegration) {
        window.chatIntegration.saveUserPreferences();
    }
});
</script>