<!-- Auto-Summary System with AI and Extractive Fallback -->
{% if page.auto_summary %}
<div class="auto-summary" id="auto-summary">
    <div class="summary-header">
        <h3 class="summary-title" data-translate="summary.title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            Riassunto Intelligente
        </h3>
        <div class="summary-controls">
            <button class="summary-toggle" id="summary-toggle" data-translate="summary.toggle" title="Mostra/Nascondi riassunto">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </button>
            <div class="summary-source" id="summary-source" title="Metodo di generazione">
                <span class="source-badge ai-badge" style="display: none;">
                    🤖 AI
                </span>
                <span class="source-badge extractive-badge" style="display: none;">
                    📊 Estrattivo
                </span>
            </div>
        </div>
    </div>
    
    <div class="summary-content" id="summary-content">
        <div class="summary-loading" id="summary-loading">
            <div class="loading-spinner"></div>
            <p data-translate="summary.loading">Generando riassunto intelligente...</p>
        </div>
        
        <div class="summary-text" id="summary-text" style="display: none;">
            <!-- AI or extractive summary will be inserted here -->
        </div>
        
        <div class="summary-metadata" id="summary-metadata" style="display: none;">
            <div class="summary-stats">
                <span class="stat">
                    <strong data-translate="summary.reading_time">Tempo di lettura:</strong>
                    <span id="summary-reading-time">{{ page.reading_time | default: 'N/A' }} min</span>
                </span>
                <span class="stat">
                    <strong data-translate="summary.word_count">Parole:</strong>
                    <span id="summary-word-count">{{ content | number_of_words }}</span>
                </span>
                <span class="stat">
                    <strong data-translate="summary.compression">Compressione:</strong>
                    <span id="summary-compression">--%</span>
                </span>
            </div>
            
            <div class="summary-actions">
                <button class="summary-action" id="copy-summary" data-translate="summary.copy">
                    📋 Copia
                </button>
                <button class="summary-action" id="share-summary" data-translate="summary.share">
                    🔗 Condividi
                </button>
                <button class="summary-action" id="regenerate-summary" data-translate="summary.regenerate">
                    🔄 Rigenera
                </button>
            </div>
        </div>
        
        <div class="summary-feedback" id="summary-feedback" style="display: none;">
            <p data-translate="summary.feedback_prompt">Quanto è accurato questo riassunto?</p>
            <div class="feedback-buttons">
                <button class="feedback-btn" data-rating="1" title="Molto inaccurato">😞</button>
                <button class="feedback-btn" data-rating="2" title="Poco accurato">😐</button>
                <button class="feedback-btn" data-rating="3" title="Abbastanza accurato">😊</button>
                <button class="feedback-btn" data-rating="4" title="Molto accurato">😍</button>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Auto-Summary System
 * Combines AI-powered summarization with extractive fallback
 */
class AutoSummary {
    constructor() {
        this.config = {
            openai: {
                apiKey: '{{ site.openai.api_key }}',
                model: '{{ site.openai.model | default: "gpt-3.5-turbo" }}',
                maxTokens: {{ site.openai.max_tokens | default: 150 }},
                temperature: {{ site.openai.temperature | default: 0.7 }},
                apiUrl: 'https://api.openai.com/v1/chat/completions'
            },
            extractive: {
                sentenceCount: 3,
                keywordWeight: 2.0,
                positionWeight: 1.5,
                lengthWeight: 1.0
            },
            fallbackEnabled: {{ site.ai_summary_enabled | default: true }},
            maxLength: {{ site.max_summary_length | default: 200 }},
            language: '{{ page.lang | default: site.lang | default: "it" }}'
        };
        
        this.articleContent = this.extractArticleContent();
        this.summary = null;
        this.summaryMethod = null;
        this.isCollapsed = localStorage.getItem('summary_collapsed') === 'true';
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.initializeUI();
        this.generateSummary();
    }
    
    setupEventListeners() {
        // Toggle summary visibility
        const toggleBtn = document.getElementById('summary-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => this.toggleSummary());
        }
        
        // Copy summary
        const copyBtn = document.getElementById('copy-summary');
        if (copyBtn) {
            copyBtn.addEventListener('click', () => this.copySummary());
        }
        
        // Share summary
        const shareBtn = document.getElementById('share-summary');
        if (shareBtn) {
            shareBtn.addEventListener('click', () => this.shareSummary());
        }
        
        // Regenerate summary
        const regenerateBtn = document.getElementById('regenerate-summary');
        if (regenerateBtn) {
            regenerateBtn.addEventListener('click', () => this.regenerateSummary());
        }
        
        // Feedback buttons
        document.querySelectorAll('#summary-feedback .feedback-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.submitFeedback(e.target.dataset.rating);
            });
        });
    }
    
    initializeUI() {
        const summaryEl = document.getElementById('auto-summary');
        if (!summaryEl) return;
        
        // Set initial collapsed state
        if (this.isCollapsed) {
            const contentEl = document.getElementById('summary-content');
            if (contentEl) {
                contentEl.style.display = 'none';
            }
            this.updateToggleIcon(true);
        }
    }
    
    extractArticleContent() {
        // Extract clean text content from article
        const articleEl = document.querySelector('article .post-content, article .content, .post-content, .content');
        if (!articleEl) {
            console.warn('No article content found for summarization');
            return '';
        }
        
        // Clone and clean the content
        const clone = articleEl.cloneNode(true);
        
        // Remove unwanted elements
        const unwantedSelectors = [
            'script', 'style', 'nav', 'aside', '.social-share',
            '.author-bio', '.related-posts', '.comments', '.ad',
            'iframe', 'video', 'audio', '.code-block', 'pre', 'code'
        ];
        
        unwantedSelectors.forEach(selector => {
            clone.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        // Get clean text
        let text = clone.textContent || clone.innerText || '';
        
        // Clean up whitespace and normalize
        text = text.replace(/\s+/g, ' ').trim();
        
        // Remove very short sentences (likely captions or noise)
        const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 20);
        
        return sentences.join('. ') + '.';
    }
    
    async generateSummary() {
        const loadingEl = document.getElementById('summary-loading');
        const textEl = document.getElementById('summary-text');
        const metadataEl = document.getElementById('summary-metadata');
        const sourceEl = document.getElementById('summary-source');
        
        if (!this.articleContent || this.articleContent.length < 100) {
            this.showError('Contenuto insufficiente per il riassunto');
            return;
        }
        
        try {
            // Show loading state
            if (loadingEl) loadingEl.style.display = 'block';
            
            // Try AI summarization first
            if (this.config.openai.apiKey && this.config.fallbackEnabled) {
                try {
                    this.summary = await this.generateAISummary();
                    this.summaryMethod = 'ai';
                    this.updateSourceBadge('ai');
                } catch (aiError) {
                    console.warn('AI summarization failed:', aiError);
                    throw aiError; // Fall through to extractive
                }
            } else {
                throw new Error('AI summarization not available');
            }
            
        } catch (error) {
            console.log('Using extractive summarization fallback');
            
            // Use extractive summarization as fallback
            try {
                this.summary = this.generateExtractiveSummary();
                this.summaryMethod = 'extractive';
                this.updateSourceBadge('extractive');
            } catch (extractiveError) {
                console.error('All summarization methods failed:', extractiveError);
                this.showError('Impossibile generare il riassunto');
                return;
            }
        }
        
        // Display the summary
        this.displaySummary();
        this.updateMetadata();
        this.showFeedbackPrompt();
        
        // Hide loading
        if (loadingEl) loadingEl.style.display = 'none';
    }
    
    async generateAISummary() {
        const prompt = this.buildPrompt();
        
        const response = await fetch(this.config.openai.apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.config.openai.apiKey}`
            },
            body: JSON.stringify({
                model: this.config.openai.model,
                messages: [
                    {
                        role: 'system',
                        content: 'Sei un assistente esperto in bioarchitettura e architettura sostenibile. Il tuo compito è creare riassunti chiari, informativi e coinvolgenti degli articoli. Mantieni il focus sui concetti chiave e sui benefici pratici.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                max_tokens: this.config.openai.maxTokens,
                temperature: this.config.openai.temperature,
                presence_penalty: 0.6,
                frequency_penalty: 0.3
            })
        });
        
        if (!response.ok) {
            throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error('Invalid response from OpenAI API');
        }
        
        const summary = data.choices[0].message.content.trim();
        
        // Validate summary quality
        if (summary.length < 50 || summary.length > this.config.maxLength * 2) {
            throw new Error('AI summary quality check failed');
        }
        
        return summary;
    }
    
    buildPrompt() {
        const wordCount = this.articleContent.split(' ').length;
        const targetLength = Math.min(this.config.maxLength, Math.max(100, wordCount / 10));
        
        let prompt = `Riassumi questo articolo di bioarchitettura in circa ${targetLength} parole. `;
        prompt += `Concentrati sui punti chiave, sui benefici pratici e sulle tecniche specifiche. `;
        prompt += `Scrivi in italiano con un tono professionale ma accessibile. `;
        prompt += `Il riassunto deve essere coinvolgente e informativo per lettori interessati all'architettura sostenibile.\n\n`;
        prompt += `ARTICOLO:\n${this.articleContent}`;
        
        // Trim if too long for API limits
        if (prompt.length > 3500) {
            const maxContentLength = 3500 - (prompt.length - this.articleContent.length);
            const trimmedContent = this.articleContent.substring(0, maxContentLength) + '...';
            prompt = prompt.replace(this.articleContent, trimmedContent);
        }
        
        return prompt;
    }
    
    generateExtractiveSummary() {
        // Split into sentences
        const sentences = this.articleContent.split(/[.!?]+/)
            .map(s => s.trim())
            .filter(s => s.length > 20);
        
        if (sentences.length < 3) {
            throw new Error('Not enough sentences for extractive summarization');
        }
        
        // Score sentences
        const scoredSentences = sentences.map((sentence, index) => ({
            text: sentence,
            score: this.scoreSentence(sentence, index, sentences.length),
            index
        }));
        
        // Sort by score and select top sentences
        const topSentences = scoredSentences
            .sort((a, b) => b.score - a.score)
            .slice(0, this.config.extractive.sentenceCount)
            .sort((a, b) => a.index - b.index); // Restore original order
        
        // Combine into summary
        const summary = topSentences.map(s => s.text).join('. ') + '.';
        
        // Trim to max length
        if (summary.length > this.config.maxLength) {
            return summary.substring(0, this.config.maxLength).trim() + '...';
        }
        
        return summary;
    }
    
    scoreSentence(sentence, position, totalSentences) {
        let score = 0;
        
        // Position scoring (beginning and end are important)
        const positionRatio = position / totalSentences;
        if (positionRatio < 0.2 || positionRatio > 0.8) {
            score += this.config.extractive.positionWeight;
        }
        
        // Length scoring (prefer medium-length sentences)
        const words = sentence.split(' ').length;
        if (words >= 10 && words <= 30) {
            score += this.config.extractive.lengthWeight;
        }
        
        // Keyword scoring
        const keywords = this.extractKeywords();
        keywords.forEach(keyword => {
            const regex = new RegExp(keyword, 'gi');
            const matches = (sentence.match(regex) || []).length;
            score += matches * this.config.extractive.keywordWeight;
        });
        
        // Technical terms bonus (bioarchitecture specific)
        const technicalTerms = [
            'bioarchitettura', 'sostenibile', 'ecologico', 'efficienza energetica',
            'materiali naturali', 'casa passiva', 'isolamento', 'termic',
            'ventilazione', 'certificazione', 'LEED', 'BREEAM', 'CasaClima'
        ];
        
        technicalTerms.forEach(term => {
            if (sentence.toLowerCase().includes(term.toLowerCase())) {
                score += 1.5;
            }
        });
        
        return score;
    }
    
    extractKeywords() {
        // Simple keyword extraction based on frequency
        const words = this.articleContent.toLowerCase()
            .replace(/[^\w\s]/g, ' ')
            .split(/\s+/)
            .filter(word => word.length > 4);
        
        const frequency = {};
        words.forEach(word => {
            frequency[word] = (frequency[word] || 0) + 1;
        });
        
        // Remove common Italian stop words
        const stopWords = [
            'essere', 'avere', 'fare', 'dire', 'andare', 'dovere', 'volere',
            'sapere', 'dare', 'stare', 'venire', 'uscire', 'parlare',
            'questo', 'quello', 'molto', 'tutto', 'grande', 'nuovo',
            'primo', 'ultimo', 'stesso', 'altro', 'ogni', 'quale',
            'quando', 'dove', 'come', 'perche', 'anche', 'ancora'
        ];
        
        const cleanFrequency = {};
        Object.keys(frequency).forEach(word => {
            if (!stopWords.includes(word) && frequency[word] > 1) {
                cleanFrequency[word] = frequency[word];
            }
        });
        
        // Return top keywords
        return Object.keys(cleanFrequency)
            .sort((a, b) => cleanFrequency[b] - cleanFrequency[a])
            .slice(0, 10);
    }
    
    displaySummary() {
        const textEl = document.getElementById('summary-text');
        if (textEl && this.summary) {
            textEl.innerHTML = this.formatSummary(this.summary);
            textEl.style.display = 'block';
        }
    }
    
    formatSummary(summary) {
        // Basic formatting and highlighting
        let formatted = summary;
        
        // Highlight key bioarchitecture terms
        const highlightTerms = [
            'bioarchitettura', 'sostenibile', 'ecologico', 'efficienza energetica',
            'casa passiva', 'certificazione', 'LEED', 'materiali naturali'
        ];
        
        highlightTerms.forEach(term => {
            const regex = new RegExp(`\\b${term}\\b`, 'gi');
            formatted = formatted.replace(regex, `<mark class="highlight-term">$&</mark>`);
        });
        
        return `<p class="summary-paragraph">${formatted}</p>`;
    }
    
    updateSourceBadge(method) {
        const sourceEl = document.getElementById('summary-source');
        if (!sourceEl) return;
        
        // Hide all badges
        sourceEl.querySelectorAll('.source-badge').forEach(badge => {
            badge.style.display = 'none';
        });
        
        // Show appropriate badge
        const badge = sourceEl.querySelector(`.${method}-badge`);
        if (badge) {
            badge.style.display = 'inline-flex';
        }
    }
    
    updateMetadata() {
        const originalWordCount = this.articleContent.split(' ').length;
        const summaryWordCount = this.summary ? this.summary.split(' ').length : 0;
        const compressionRatio = summaryWordCount > 0 ? 
            Math.round((1 - summaryWordCount / originalWordCount) * 100) : 0;
        
        // Update compression ratio
        const compressionEl = document.getElementById('summary-compression');
        if (compressionEl) {
            compressionEl.textContent = `${compressionRatio}%`;
        }
        
        // Show metadata
        const metadataEl = document.getElementById('summary-metadata');
        if (metadataEl) {
            metadataEl.style.display = 'block';
        }
    }
    
    showFeedbackPrompt() {
        setTimeout(() => {
            const feedbackEl = document.getElementById('summary-feedback');
            if (feedbackEl) {
                feedbackEl.style.display = 'block';
            }
        }, 3000); // Show after 3 seconds
    }
    
    toggleSummary() {
        const contentEl = document.getElementById('summary-content');
        const toggleBtn = document.getElementById('summary-toggle');
        
        if (!contentEl || !toggleBtn) return;
        
        this.isCollapsed = !this.isCollapsed;
        
        if (this.isCollapsed) {
            contentEl.style.display = 'none';
        } else {
            contentEl.style.display = 'block';
        }
        
        this.updateToggleIcon(this.isCollapsed);
        localStorage.setItem('summary_collapsed', this.isCollapsed.toString());
    }
    
    updateToggleIcon(collapsed) {
        const toggleBtn = document.getElementById('summary-toggle');
        if (!toggleBtn) return;
        
        const icon = toggleBtn.querySelector('svg polyline');
        if (icon) {
            icon.setAttribute('points', collapsed ? '18 15 12 9 6 15' : '6 9 12 15 18 9');
        }
    }
    
    async copySummary() {
        if (!this.summary) return;
        
        try {
            await navigator.clipboard.writeText(this.summary);
            this.showNotification('Riassunto copiato negli appunti! 📋');
        } catch (error) {
            console.error('Failed to copy summary:', error);
            this.showNotification('Errore durante la copia', 'error');
        }
    }
    
    shareSummary() {
        if (!this.summary) return;
        
        const shareData = {
            title: document.title,
            text: this.summary,
            url: window.location.href
        };
        
        if (navigator.share) {
            navigator.share(shareData).catch(console.error);
        } else {
            // Fallback: copy share text to clipboard
            const shareText = `${shareData.title}\n\n${shareData.text}\n\n${shareData.url}`;
            navigator.clipboard.writeText(shareText).then(() => {
                this.showNotification('Link per condividere copiato! 🔗');
            }).catch(console.error);
        }
    }
    
    async regenerateSummary() {
        const regenerateBtn = document.getElementById('regenerate-summary');
        if (regenerateBtn) {
            regenerateBtn.disabled = true;
            regenerateBtn.textContent = '🔄 Rigenerando...';
        }
        
        try {
            // Clear current summary
            this.summary = null;
            const textEl = document.getElementById('summary-text');
            if (textEl) textEl.style.display = 'none';
            
            // Regenerate
            await this.generateSummary();
            
            this.showNotification('Riassunto rigenerato! ✨');
        } catch (error) {
            console.error('Failed to regenerate summary:', error);
            this.showNotification('Errore durante la rigenerazione', 'error');
        } finally {
            if (regenerateBtn) {
                regenerateBtn.disabled = false;
                regenerateBtn.textContent = '🔄 Rigenera';
            }
        }
    }
    
    submitFeedback(rating) {
        const feedbackData = {
            rating: parseInt(rating),
            summary: this.summary,
            method: this.summaryMethod,
            articleUrl: window.location.pathname,
            timestamp: Date.now()
        };
        
        // Send to analytics endpoint
        fetch('/api/summary-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(feedbackData)
        }).catch(console.warn);
        
        // Hide feedback prompt
        const feedbackEl = document.getElementById('summary-feedback');
        if (feedbackEl) {
            feedbackEl.style.display = 'none';
        }
        
        this.showNotification('Grazie per il feedback! 🙏');
    }
    
    showError(message) {
        const summaryEl = document.getElementById('auto-summary');
        if (summaryEl) {
            summaryEl.innerHTML = `
                <div class="summary-error">
                    <p>⚠️ ${message}</p>
                </div>
            `;
        }
    }
    
    showNotification(message, type = 'success') {
        // Reuse notification system from main.js
        if (window.NotificationManager) {
            window.NotificationManager.show(message, type);
        } else {
            console.log(`Notification: ${message}`);
        }
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('auto-summary')) {
        window.autoSummary = new AutoSummary();
    }
});
</script>
{% endif %}