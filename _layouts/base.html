<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'it' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Security Headers as meta tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), interest-cohort=()">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://identity.netlify.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.netlify.com; frame-src https://www.youtube.com https://player.vimeo.com; object-src 'none'; base-uri 'self'; form-action 'self' https://formspree.io; upgrade-insecure-requests">
    
    <!-- Standard meta tags -->
    <title>{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}</title>
    <meta name="description" content="{{ page.description | default: site.description | strip_html | normalize_whitespace | truncate: 160 }}">
    <meta name="keywords" content="{{ page.keywords | default: site.keywords }}">
    <meta name="author" content="{{ page.author | default: site.author }}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ page.url | absolute_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta property="og:title" content="{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}">
    <meta property="og:description" content="{{ page.description | default: site.description | strip_html | normalize_whitespace | truncate: 160 }}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ page.url | absolute_url }}">
    <meta property="twitter:title" content="{% if page.title %}{{ page.title }} - {{ site.title }}{% else %}{{ site.title }}{% endif %}">
    <meta property="twitter:description" content="{{ page.description | default: site.description | strip_html | normalize_whitespace | truncate: 160 }}">
    
    <!-- Robots meta tag -->
    {% if page.noindex %}
    <meta name="robots" content="noindex, nofollow">
    {% else %}
    <meta name="robots" content="index, follow">
    {% endif %}
    
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ '/assets/main.css' | relative_url }}" as="style">
    
    <!-- DNS prefetch for external domains -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//fonts.gstatic.com">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ '/assets/main.css' | relative_url }}">
    {% feed_meta %}
    
    <!-- Additional page-specific head content -->
    {% if page.head %}{{ page.head }}{% endif %}
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "{{ site.title }}",
        "url": "{{ site.url }}",
        "description": "{{ site.description }}",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "Via Portici, 71",
            "addressLocality": "Bolzano",
            "postalCode": "39100",
            "addressCountry": "IT"
        }
    }
    </script>
</head>
<body class="{{ page.layout }}{% if page.body_class %} {{ page.body_class }}{% endif %}">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="page-wrapper">
        {{ content }}
    </div>
    
    <!-- Critical inline scripts only -->
    <script>
        // Basic security: prevent clickjacking
        if (top !== self) {
            top.location = self.location;
        }
        
        // Performance: preload next likely pages
        document.addEventListener('DOMContentLoaded', function() {
            const links = document.querySelectorAll('a[href^="/public/"]');
            links.forEach(function(link) {
                link.addEventListener('mouseenter', function() {
                    const preloadLink = document.createElement('link');
                    preloadLink.rel = 'prefetch';
                    preloadLink.href = this.href;
                    document.head.appendChild(preloadLink);
                });
            });
        });
    </script>
    
    <!-- Additional page-specific scripts -->
    {% if page.scripts %}
        {% for script in page.scripts %}
            <script src="{{ script | relative_url }}" defer></script>
        {% endfor %}
    {% endif %}
</body>
</html>